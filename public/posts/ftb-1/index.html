<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Building A Future Trading Bot: Part 1 ¬∑ Ahmed Nadeem
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Ahmed Nadeem">
<meta name="description" content="building a future trading bot in Golang: Part 1">
<meta name="keywords" content="blog,developer,personal">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building A Future Trading Bot: Part 1"/>
<meta name="twitter:description" content="building a future trading bot in Golang: Part 1"/>

<meta property="og:title" content="Building A Future Trading Bot: Part 1" />
<meta property="og:description" content="building a future trading bot in Golang: Part 1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ahmed-deftoner.github.io/posts/ftb-1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-12T21:33:28+05:00" />
<meta property="article:modified_time" content="2024-04-12T21:33:28+05:00" />






<link rel="canonical" href="https://ahmed-deftoner.github.io/posts/ftb-1/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css" integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://ahmed-deftoner.github.io">
      Ahmed Nadeem
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/contact/">Contact me</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://ahmed-deftoner.github.io/posts/ftb-1/">
              Building A Future Trading Bot: Part 1
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-04-12T21:33:28&#43;05:00">
                April 12, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              7-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="/authors/ahmed-nadeem/">Ahmed Nadeem</a></div>

          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/golang/">golang</a>
    </span>
      <span class="separator">‚Ä¢</span>
    <span class="tag">
      <a href="/tags/cryptocurrency/">cryptocurrency</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>In this series we&rsquo;ll create a future trading bot in Golang, that will connect with a cryptocuurency exchange and start trading based on a strategy that we&rsquo;ll discuss in future blog posts. Since this is the first entry of this series, there is alot of stuff that we need to setup before we go deep into the exciting stuff - hopefully making some profit from cryptocurrenices üòÅ. Moreover, I have chosen cryptocurrencies for this bot since the tech behind it is pretty solid and alot of exchnages have really good documentation for developers, but this approach could also be used for any other trading platform. Finally, I am also assuming that anyone who&rsquo;s reading this article is not writing their first Golang program, although Golang is pretty easy, this won&rsquo;t be a Golang tutorial. So let&rsquo;s begin.</p>
<p>First let&rsquo;s initialize the project with <code>go mod init &lt;project name&gt;</code> and let&rsquo;s connect it with a Postgres database. For now we&rsquo;ll only need the database to store api key information that we&rsquo;ll get from the crypto exchange. Here&rsquo;s how your env would look for now:</p>
<pre tabindex="0"><code># Postgres Live
DB_HOST=
DB_DRIVER=postgres
DB_USER=
DB_PASSWORD=
DB_NAME=
DB_PORT=5432 #Default postgres port

#Encryption
ENCRYPTION_PASS=
</code></pre><p>Now let&rsquo;s setup our model, we&rsquo;ll be using Gorm to connect with the database and define our models. In models/key.go:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// models/key.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Key</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Keyid</span>           <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span> <span class="s">`gorm:&#34;primary_key;type:uuid;default:gen_random_uuid()&#34; json:&#34;key_id&#34;`</span>
	<span class="nx">ApiKey</span>          <span class="kt">string</span>    <span class="s">`gorm:&#34;not null;unique&#34; json:&#34;api_key&#34;`</span>
	<span class="nx">SecretKey</span>       <span class="kt">string</span>    <span class="s">`gorm:&#34;not null;unique&#34; json:&#34;secret_key&#34;`</span>
	<span class="nx">Passphrase</span>      <span class="kt">string</span>    <span class="s">`gorm:&#34;&#34; json:&#34;passphrase&#34;`</span>
	<span class="nx">UserEmail</span>       <span class="kt">string</span>    <span class="s">`json:&#34;user_email&#34;`</span>
	<span class="nx">TradeAmount</span>     <span class="kt">int</span>
	<span class="nx">AllowedCoins</span>    <span class="kt">int</span>
	<span class="nx">CapitalPerTrade</span> <span class="kt">float64</span>
	<span class="nx">Start</span>           <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></div><p>Trade amount will be the amount we deposit in our futures account, allowed coins would be the number of coin pairs we can trade with at a time, since it will be dependent on our trade amount, we need to set a limit, you could remove trade amount, and get it from the exchanges' API, but I have added to the DB since it would save us a network call to the exchange. Capital per trade is the amount for opening one position on the exchange. So, for example, I can set my trade amount to be $600, and I set the allowed coins to be 3, and capital per trade to be $20; that would mean, at a single time 3 coin pair positions will be opened on the exchange each worth $20. Finally, I have a start flag, since I would want to temporarily stop my bot, since by default it should keep trading. The rest of the fields are self explanatory üòâ.</p>
<p>Next, we&rsquo;ll initialize our database and server. We&rsquo;ll be needing some API endpoints as well since we need to do some trivial stuff, like adding keys for now.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// controllers/server.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">controllers</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;github.com/gorilla/mux&#34;</span>
	<span class="s">&#34;github.com/jinzhu/gorm&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/jinzhu/gorm/dialects/postgres&#34;</span> <span class="c1">//postgres database driver
</span><span class="c1"></span><span class="p">)</span>

<span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">DB</span>     <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
	<span class="nx">Router</span> <span class="o">*</span><span class="nx">mux</span><span class="p">.</span><span class="nx">Router</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Initialize</span><span class="p">(</span><span class="nx">Dbdriver</span><span class="p">,</span> <span class="nx">DbUser</span><span class="p">,</span> <span class="nx">DbPassword</span><span class="p">,</span> <span class="nx">DbPort</span><span class="p">,</span> <span class="nx">DbHost</span><span class="p">,</span> <span class="nx">DbName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="nx">DBURL</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;host=%s port=%s user=%s dbname=%s sslmode=disable password=%s&#34;</span><span class="p">,</span> <span class="nx">DbHost</span><span class="p">,</span> <span class="nx">DbPort</span><span class="p">,</span> <span class="nx">DbUser</span><span class="p">,</span> <span class="nx">DbName</span><span class="p">,</span> <span class="nx">DbPassword</span><span class="p">)</span>
	<span class="nx">server</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">Dbdriver</span><span class="p">,</span> <span class="nx">DBURL</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Cannot connect to the %s database&#34;</span><span class="p">,</span> <span class="nx">Dbdriver</span><span class="p">)</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;This is the error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Connected to the %s database&#34;</span><span class="p">,</span> <span class="nx">Dbdriver</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">server</span><span class="p">.</span><span class="nx">Router</span> <span class="p">=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">()</span>
	<span class="nx">server</span><span class="p">.</span><span class="nf">initializeRoutes</span><span class="p">()</span>

	<span class="nx">server</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nf">AutoMigrate</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">models</span><span class="p">.</span><span class="nx">Key</span><span class="p">{})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Listening on port 8080&#34;</span><span class="p">)</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">+</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">Router</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><p>We haven&rsquo;t created the function for initializing routes, we&rsquo;ll do that now:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// controllers/routes.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">controllers</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">initializeRoutes</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nf">PathPrefix</span><span class="p">(</span><span class="s">&#34;/bot&#34;</span><span class="p">).</span><span class="nf">Subrouter</span><span class="p">()</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">MiddlewareJSON</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Home</span><span class="p">)).</span><span class="nf">Methods</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/create-key&#34;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nf">MiddlewareJSON</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">CreateKey</span><span class="p">)).</span><span class="nf">Methods</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>Nice, for the moment I have added a home route for testing - also for health checks - and a create key route to add an api key to the database. We&rsquo;ll also need some middleware functions to set headers for JSON, since it would be repeated work if we did that for each route.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// middleware/middleware.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">middleware</span>

<span class="kn">import</span> <span class="s">&#34;net/http&#34;</span>

<span class="kd">func</span> <span class="nf">MiddlewareJSON</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;application/json&#34;</span><span class="p">)</span>
		<span class="nf">next</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Before creating the route functions, let&rsquo;s create some functions for model, and some helper functions for encrypting and decrypting sensitive data like api key, secret key, and passphrase.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// model/key.go
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">k</span> <span class="o">*</span><span class="nx">Key</span><span class="p">)</span> <span class="nf">FindAllKeys</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">[]</span><span class="nx">Key</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">Keys</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Key</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Key</span><span class="p">{}).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Keys</span><span class="p">).</span><span class="nx">Error</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="p">[]</span><span class="nx">Key</span><span class="p">{},</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Keys</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">k</span> <span class="o">*</span><span class="nx">Key</span><span class="p">)</span> <span class="nf">SaveKey</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Key</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">k</span><span class="p">).</span><span class="nx">Error</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Key</span><span class="p">{},</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">k</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">k</span> <span class="o">*</span><span class="nx">Key</span><span class="p">)</span> <span class="nf">FindKeysByEmail</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">email</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">[]</span><span class="nx">Key</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">Keys</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Key</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="nx">Key</span><span class="p">{}).</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;user_email = ?&#34;</span><span class="p">,</span> <span class="nx">email</span><span class="p">).</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Keys</span><span class="p">).</span><span class="nx">Error</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="p">[]</span><span class="nx">Key</span><span class="p">{},</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Keys</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>And the encryption, decryption functions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// codec/codec.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">codec</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;crypto/aes&#34;</span>
	<span class="s">&#34;crypto/cipher&#34;</span>
	<span class="s">&#34;crypto/rand&#34;</span>
	<span class="s">&#34;encoding/hex&#34;</span>
	<span class="s">&#34;errors&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">Encrypt</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">text</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">block</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">aes</span><span class="p">.</span><span class="nf">NewCipher</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">ciphertext</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">aes</span><span class="p">.</span><span class="nx">BlockSize</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span>
	<span class="nx">iv</span> <span class="o">:=</span> <span class="nx">ciphertext</span><span class="p">[:</span><span class="nx">aes</span><span class="p">.</span><span class="nx">BlockSize</span><span class="p">]</span>
	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">iv</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">stream</span> <span class="o">:=</span> <span class="nx">cipher</span><span class="p">.</span><span class="nf">NewCFBEncrypter</span><span class="p">(</span><span class="nx">block</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">XORKeyStream</span><span class="p">(</span><span class="nx">ciphertext</span><span class="p">[</span><span class="nx">aes</span><span class="p">.</span><span class="nx">BlockSize</span><span class="p">:],</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%x&#34;</span><span class="p">,</span> <span class="nx">ciphertext</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Decrypt</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">text</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ciphertext</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">hex</span><span class="p">.</span><span class="nf">DecodeString</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">block</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">aes</span><span class="p">.</span><span class="nf">NewCipher</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ciphertext</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">aes</span><span class="p">.</span><span class="nx">BlockSize</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;ciphertext too short&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">iv</span> <span class="o">:=</span> <span class="nx">ciphertext</span><span class="p">[:</span><span class="nx">aes</span><span class="p">.</span><span class="nx">BlockSize</span><span class="p">]</span>
	<span class="nx">ciphertext</span> <span class="p">=</span> <span class="nx">ciphertext</span><span class="p">[</span><span class="nx">aes</span><span class="p">.</span><span class="nx">BlockSize</span><span class="p">:]</span>
	<span class="nx">stream</span> <span class="o">:=</span> <span class="nx">cipher</span><span class="p">.</span><span class="nf">NewCFBDecrypter</span><span class="p">(</span><span class="nx">block</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">XORKeyStream</span><span class="p">(</span><span class="nx">ciphertext</span><span class="p">,</span> <span class="nx">ciphertext</span><span class="p">)</span>
	<span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">ciphertext</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>Now, we&rsquo;ll create the routes for the health check and for creating the key.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// controllers/key.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">controllers</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;errors&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;os&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">KeyRequest</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ApiKey</span>          <span class="kt">string</span>  <span class="s">`json:&#34;api_key&#34;`</span>
	<span class="nx">SecretKey</span>       <span class="kt">string</span>  <span class="s">`json:&#34;secret_key&#34;`</span>
	<span class="nx">Passphrase</span>      <span class="kt">string</span>  <span class="s">`json:&#34;passphrase&#34;`</span>
	<span class="nx">UserEmail</span>       <span class="kt">string</span>  <span class="s">`json:&#34;user_email&#34;`</span>
	<span class="nx">TradeAmount</span>     <span class="kt">int</span>     <span class="s">`json:&#34;trade_amount&#34;`</span>
	<span class="nx">AllowedCoins</span>    <span class="kt">int</span>     <span class="s">`json:&#34;allowed_coins&#34;`</span>
	<span class="nx">CapitalPerTrade</span> <span class="kt">float64</span> <span class="s">`json:&#34;capital_per_trade&#34;`</span>
	<span class="nx">Start</span>           <span class="kt">bool</span>    <span class="s">`json:&#34;start&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">CreateKey</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">encryptionKey</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;ENCRYPTION_PASS&#34;</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">keyRequest</span> <span class="nx">KeyRequest</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">keyRequest</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">ERROR</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;bad params for key&#34;</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">encryptedApiKey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">Encrypt</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">encryptionKey</span><span class="p">),</span> <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">ApiKey</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">ERROR</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;failed to encrypt api key&#34;</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">encryptedSecretKey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">Encrypt</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">encryptionKey</span><span class="p">),</span> <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">SecretKey</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">ERROR</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;failed to encrypt secret key&#34;</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">encryptedPassphrase</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">Encrypt</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">encryptionKey</span><span class="p">),</span> <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">Passphrase</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">ERROR</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;failed to encrypt passphrase&#34;</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="c1">// Create Key object
</span><span class="c1"></span>	<span class="nx">key</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">models</span><span class="p">.</span><span class="nx">Key</span><span class="p">{</span>
		<span class="nx">ApiKey</span><span class="p">:</span>          <span class="nx">encryptedApiKey</span><span class="p">,</span>
		<span class="nx">SecretKey</span><span class="p">:</span>       <span class="nx">encryptedSecretKey</span><span class="p">,</span>
		<span class="nx">Passphrase</span><span class="p">:</span>      <span class="nx">encryptedPassphrase</span><span class="p">,</span>
		<span class="nx">UserEmail</span><span class="p">:</span>       <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">UserEmail</span><span class="p">,</span>
		<span class="nx">TradeAmount</span><span class="p">:</span>     <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">TradeAmount</span><span class="p">,</span>
		<span class="nx">AllowedCoins</span><span class="p">:</span>    <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">AllowedCoins</span><span class="p">,</span>
		<span class="nx">CapitalPerTrade</span><span class="p">:</span> <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">CapitalPerTrade</span><span class="p">,</span>
		<span class="nx">Start</span><span class="p">:</span>           <span class="nx">keyRequest</span><span class="p">.</span><span class="nx">Start</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nx">key</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">key</span><span class="p">.</span><span class="nf">SaveKey</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">response</span><span class="p">.</span><span class="nf">ERROR</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;failed to save key&#34;</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">response</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>For the health check:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="c1">// controllers/home.go
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">controllers</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Home</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">response</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;Future Trading Bot&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>You might be wondering what this response package is; since I have added some reusable logic in the middleware functions for setting headers, I have created some functions to handle sending responses as well:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="kn">package</span> <span class="nx">response</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">JSON</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">status</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">data</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;application/json&#34;</span><span class="p">)</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">ERROR</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">JSON</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">,</span> <span class="kd">struct</span> <span class="p">{</span>
			<span class="nx">Error</span> <span class="kt">string</span> <span class="s">`json:&#34;error&#34;`</span>
		<span class="p">}{</span>
			<span class="nx">Error</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span>
		<span class="p">})</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nf">JSON</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>Phew, that&rsquo;s alot of work for a single post xD, but we&rsquo;re almost done. Finally we&rsquo;re left with the main.go file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Go" data-lang="Go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;os&#34;</span>

	<span class="s">&#34;github.com/joho/godotenv&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="p">=</span> <span class="nx">controllers</span><span class="p">.</span><span class="nx">Server</span><span class="p">{}</span>

<span class="kd">func</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">godotenv</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;Error getting env&#34;</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Getting Values&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">server</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_DRIVER&#34;</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_USER&#34;</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_PASSWORD&#34;</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_PORT&#34;</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_HOST&#34;</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DB_NAME&#34;</span><span class="p">))</span>
	<span class="nx">server</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><p>We&rsquo;re loading the env variables and initializing the server (and the database) and running it. Now I&rsquo;ll be using Bitget as ny exchange and I&rsquo;ll be creating the bot to interact with their API since their documentation is pretty good. You can go to their dashboard and open their API section and create a new system generated key, give it read/write permissions, allow future trading and then copy the key details. Post the key to the create key route using Postman, and we&rsquo;re done. In the next part we&rsquo;ll connect with Bitget and get some basic API operations running. Adios.</p>

      </div>


      <footer>
        

<section class="see-also">
  
    
    
    
  
</section>


        
        
        
        
        

        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ¬©
    
      2023 -
    
    2024
     Ahmed Nadeem 
    ¬∑
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.369d90111ae4409b4e51de5efd23a46b92663fcc82dc9a0efde7f70bffc3f949.js" integrity="sha256-Np2QERrkQJtOUd5e/SOka5JmP8yC3JoO/ef3C//D&#43;Uk="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
